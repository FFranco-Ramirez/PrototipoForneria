{% extends "base.html" %}
{% load static %}
{% block contenido %}
<div class="dashboard-main-container">
    <!-- Sidebar Reutilizable -->
    {% include 'includes/sidebar.html' with active_page='dashboard' %}
    <!-- Main Content -->
    <div class="dashboard-content-wrapper">
        <!-- Header con título específico del dashboard -->
        {% include 'includes/dashboard_header.html' with page_title='Resumen del Día' %}
        <!-- Content -->
        <main class="dashboard-content">
            <!-- ============================================ -->
            <!-- FILA 1: MÉTRICAS PRINCIPALES (4 COLUMNAS)   -->
            <!-- ============================================ -->
            <div class="dashboard-row">
                <!-- Columna 1: Ventas del Día -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Ventas del Día</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">-- transacciones</p>
                    </div>
                </div>

                <!-- Columna 2: Stock Bajo -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Stock Bajo</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">Productos</p>
                    </div>
                </div>

                <!-- Columna 3: Alertas -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Alertas</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">Pendientes</p>
                    </div>
                </div>

                <!-- Columna 4: Top Producto -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Top Producto</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">-- unidades</p>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- FILA 2: ANÁLISIS DE VENCIMIENTOS 7 Y 14 DÍAS (4 COLUMNAS) -->
            <!-- ============================================ -->
            <div class="dashboard-row">
                <!-- Columna 1: LISTADOS DE VENCIMIENTOS (7 y 14 días) -->
                <div class="dashboard-col">
                    <!-- Listado 7 días -->
                    <div class="dashboard-metric-card" id="vencimientos-card">
                        <h3 class="metric-card-title">Por vencer (7 días)</h3>
                        <ul id="vencimientos-list" class="metric-list"></ul>
                        <div id="vencimientos-extra" style="display: none;">
                            <ul id="vencimientos-extra-list" class="metric-list"></ul>
                        </div>
                        <button id="vencimientos-toggle" class="metric-card-button" style="display:none;">Ver más</button>
                    </div>

                    <!-- Listado 14 días -->
                    <div class="dashboard-metric-card" id="vencimientos-14-card">
                        <h3 class="metric-card-title">Por vencer (14 días)</h3>
                        <ul id="vencimientos-14-list" class="metric-list"></ul>
                        <div id="vencimientos-14-extra" style="display: none;">
                            <ul id="vencimientos-14-extra-list" class="metric-list"></ul>
                        </div>
                        <button id="vencimientos-14-toggle" class="metric-card-button" style="display:none;">Ver más</button>
                    </div>
                </div>

                <!-- Columna 2: GRÁFICOS DE PÉRDIDA POTENCIAL (7 y 14 días) -->
                <div class="dashboard-col">
                    <!-- Gráfico 7 días -->
                    <div class="dashboard-metric-card" id="d3-gauge-container-7-days">
                        <h3 class="metric-card-title">Pérdida potencial (7 días)</h3>
                    </div>

                    <!-- Gráfico 14 días -->
                    <div class="dashboard-metric-card" id="d3-gauge-container-14-days">
                        <h3 class="metric-card-title">Pérdida potencial (14 días)</h3>
                    </div>
                </div>

                <!-- Columna 3: LISTA DE VENTAS DEL DÍA (colapsable) -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card" id="ventas-dia-card" style="min-height: auto; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px;">
                            <h3 class="metric-card-title" style="margin: 0; flex: 1;">
                                <i class="bi bi-cash-coin" style="color: #D4AF37;"></i>
                                Ventas del Día (Detalle)
                            </h3>
                            <button id="ventas-dia-toggle" class="btn btn-sm btn-link" style="padding: 4px 8px; text-decoration: none; color: #6c757d;">
                                <i class="bi bi-chevron-down" id="ventas-dia-icon"></i>
                            </button>
                        </div>
                        <div id="tabla-ventas-dia-container" style="display: none; max-height: 400px; overflow-y: auto; width: 100%;">
                            <div id="tabla-ventas-dia">
                                <p class="text-muted" id="tabla-ventas-dia-loading">Cargando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna 4: LISTA DE MERMA (al lado derecho de Ventas del Día) -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card" style="min-height: auto; height: 100%;">
                        <h3 class="metric-card-title">
                            <i class="bi bi-trash-fill" style="color: #ff6b6b;"></i>
                            Productos en Merma
                        </h3>
                        <div id="tabla-merma" style="max-height: 400px; overflow-y: auto; flex: 1;">
                            <p class="text-muted" id="tabla-merma-loading">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- FILA 2.5: CARDS DE 30 DÍAS + STOCK BAJO (4 COLUMNAS) -->
            <!-- ============================================ -->
            <div class="dashboard-row">
                <!-- Columna 1: LISTADO DE VENCIMIENTOS (30 días) -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card" id="vencimientos-30-card">
                        <h3 class="metric-card-title">Por vencer (30 días)</h3>
                        <ul id="vencimientos-30-list" class="metric-list"></ul>
                        <div id="vencimientos-30-extra" style="display: none;">
                            <ul id="vencimientos-30-extra-list" class="metric-list"></ul>
                        </div>
                        <button id="vencimientos-30-toggle" class="metric-card-button" style="display:none;">Ver más</button>
                    </div>
                </div>

                <!-- Columna 2: GRÁFICO DE PÉRDIDA POTENCIAL (30 días) -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card" id="d3-gauge-container-30-days">
                        <h3 class="metric-card-title">Pérdida potencial (30 días)</h3>
                    </div>
                </div>

                <!-- Columna 3: LISTA DE STOCK BAJO (al lado derecho del card de 30 días) -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card" style="min-height: auto; height: 100%;">
                        <h3 class="metric-card-title">
                            <i class="bi bi-exclamation-triangle-fill" style="color: #ff6b6b;"></i>
                            Productos con Stock Bajo
                        </h3>
                        <div id="tabla-stock-bajo" style="max-height: 400px; overflow-y: auto; flex: 1;">
                            <p class="text-muted" id="tabla-stock-bajo-loading">Cargando...</p>
                        </div>
                    </div>
                </div>

                <!-- Columna 4: ESPACIO RESERVADO -->
                <div class="dashboard-col empty-column">
                    <!-- Espacio reservado para futuras funcionalidades -->
                </div>
            </div>

            <!-- ============================================ -->
            <!-- FILA 3: TABLAS DETALLADAS (4 COLUMNAS)      -->
            <!-- ============================================ -->
            <div class="dashboard-row">
                <!-- Columna 1, 2, 3 y 4: ESPACIO RESERVADO -->
                <div class="dashboard-col empty-column" style="flex: 4;">
                    <!-- Espacio reservado para futuras funcionalidades -->
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<!-- Script para cargar métricas del dashboard -->
<script src="{% static 'js/dashboard_metrics.js' %}?v=3"></script>

<!-- Script para expiraciones -->
<script src="{% static 'js/expiraciones.js' %}?v=2"></script>

<!-- D3.js (necesario para los gráficos) -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Nuestro archivo de gráficos reutilizable -->
<script src="{% static 'js/dashboard_charts.js' %}"></script>

<!-- Inicialización de los gráficos del dashboard -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de 7 días
    initGaugeChart(
        '#d3-gauge-container-7-days',
        "{% url 'api_perdida_potencial' %}",
        10000000,
        'Pérdida Potencial'
    );

    // Gráfico de 14 días
    initGaugeChart(
        '#d3-gauge-container-14-days',
        "{% url 'api_perdida_potencial_14' %}",
        10000000,
        'Pérdida Potencial'
    );

    // Gráfico de 30 días
    initGaugeChart(
        '#d3-gauge-container-30-days',
        "{% url 'api_perdida_potencial_30' %}",
        10000000,
        'Pérdida Potencial'
    );

    // Funcionalidad de colapsar/expandir para Ventas del Día
    const ventasDiaToggle = document.getElementById('ventas-dia-toggle');
    const ventasDiaContainer = document.getElementById('tabla-ventas-dia-container');
    const ventasDiaIcon = document.getElementById('ventas-dia-icon');
    const ventasDiaCard = document.getElementById('ventas-dia-card');
    const gauge14Days = document.getElementById('d3-gauge-container-14-days');

    if (ventasDiaToggle && ventasDiaContainer && ventasDiaCard && gauge14Days) {
        // Función para establecer altura inicial basada en el card de 14 días
        function setInitialHeight() {
            const gaugeHeight = gauge14Days.offsetHeight;
            ventasDiaCard.style.height = gaugeHeight + 'px';
            ventasDiaCard.style.overflow = 'hidden';
        }

        // Establecer altura inicial cuando el contenido esté cargado
        setTimeout(() => {
            setInitialHeight();
        }, 500);

        // Toggle para expandir/colapsar
        ventasDiaToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isExpanded = ventasDiaContainer.style.display !== 'none';
            
            if (isExpanded) {
                // Colapsar
                ventasDiaContainer.style.display = 'none';
                ventasDiaIcon.classList.remove('bi-chevron-up');
                ventasDiaIcon.classList.add('bi-chevron-down');
                setInitialHeight();
            } else {
                // Expandir
                ventasDiaContainer.style.display = 'block';
                ventasDiaIcon.classList.remove('bi-chevron-down');
                ventasDiaIcon.classList.add('bi-chevron-up');
                ventasDiaCard.style.height = 'auto';
                ventasDiaCard.style.overflow = 'visible';
            }
        });
    }
});
</script>
{% endblock %}