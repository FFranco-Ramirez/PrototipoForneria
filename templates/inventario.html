{% extends "base.html" %}
{% load static %}

{% block body_class %}dark-gold-theme{% endblock %}

{% block contenido %}
<div class="dashboard-main-container">
    <!-- Sidebar Reutilizable -->
    {% include 'includes/sidebar.html' with active_page='inventario' %}

    <div class="dashboard-content-wrapper">
        <div class="inventory-container dark-gold-theme">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Inventario</h2>
                <a href="{% url 'ajustes_stock' %}" class="btn btn-warning" style="color: #000;">
                    <i class="bi bi-sliders"></i> Ajustes de Stock
                </a>
            </div>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- ============================================ -->
  <!-- BARRA DE BÚSQUEDA                            -->
  <!-- ============================================ -->
  <!-- 
    Permite buscar productos por nombre, marca o formato.
    La búsqueda se realiza en el servidor (Django ORM).
  -->
  <form method="get" class="inventory-search" novalidate>
    <input type="text" 
           name="q" 
           value="{{ q }}" 
           placeholder="Buscar por nombre, marca o formato"
           class="form-control">
    <button type="submit" class="btn btn-sm btn-primary">
      <i class="bi bi-search"></i> Buscar
    </button>
    {% if q %}
      <a href="{% url 'inventario' %}" class="btn btn-sm btn-link">
        <i class="bi bi-x-circle"></i> Limpiar
      </a>
    {% endif %}
  </form>

  <!-- ============================================ -->
  <!-- BOTONES DE ACCIÓN MASIVA                     -->
  <!-- ============================================ -->
  <!-- 
    Estos botones permiten realizar acciones sobre múltiples productos
    seleccionados mediante checkboxes.
    
    ACCIONES DISPONIBLES:
    - Crear Alertas: Genera alertas de vencimiento para los productos seleccionados
    - Mover a Merma: Cambia el estado de los productos a "merma"
    - Eliminar: Elimina los productos seleccionados (borrado lógico)
  -->
  <div class="inventory-bulk-actions-bar mb-3">
    <div class="d-flex align-items-center gap-2">
      <!-- Contador de productos seleccionados -->
      <span id="contador-seleccionados" class="badge bg-secondary">
        0 seleccionados
      </span>
      
      <!-- Botón: Crear Alertas -->
      <button type="button" 
              class="btn btn-sm btn-warning" 
              id="btn-crear-alertas"
              onclick="accionMasiva('crear_alertas')"
              disabled>
        <i class="bi bi-bell"></i> Crear Alertas
      </button>
      
      <!-- Botón: Mover a Merma -->
      <button type="button" 
              class="btn btn-sm btn-danger" 
              id="btn-mover-merma"
              onclick="accionMasiva('mover_merma')"
              disabled>
        <i class="bi bi-exclamation-triangle"></i> Mover a Merma
      </button>
      
      <!-- Botón: Eliminar -->
      <button type="button" 
              class="btn btn-sm btn-outline-danger" 
              id="btn-eliminar"
              onclick="accionMasiva('eliminar')"
              disabled>
        <i class="bi bi-trash"></i> Eliminar
      </button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- TABLA DE INVENTARIO - VISTA SIMPLIFICADA    -->
  <!-- ============================================ -->
  <!-- 
    Esta tabla muestra solo la información esencial de cada producto.
    Se eliminaron las columnas de Categoría y Tipo para mantener la vista limpia.
    Los precios se muestran sin decimales (formato chileno).
    
    NUEVA FUNCIONALIDAD:
    - Checkbox en cada fila para selección múltiple
    - Checkbox en el header para seleccionar/deseleccionar todos
  -->
  <table class="table table-striped table-sm inventory-table">
    <thead>
      <tr>
        <!-- Checkbox para seleccionar/deseleccionar todos -->
        <th style="width: 40px;">
          <input type="checkbox" 
                 id="checkbox-todos" 
                 class="form-check-input"
                 title="Seleccionar todos">
        </th>
        <th>Nombre</th>
        <th>Marca</th>
        <th>Formato</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Caducidad</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in productos %}
      <tr>
        <!-- Checkbox individual para este producto -->
        <td>
          <input type="checkbox" 
                 class="form-check-input producto-checkbox" 
                 value="{{ p.id }}"
                 data-nombre="{{ p.nombre }}">
        </td>
        
        <!-- Nombre del producto -->
        <td><strong>{{ p.nombre }}</strong></td>
        
        <!-- Marca (muestra "—" si no tiene) -->
        <td>{{ p.marca|default:"—" }}</td>
        
        <!-- Formato (ej: "500 g", "1 L") -->
        <td>{{ p.formato|default:"—" }}</td>
        
        <!-- Precio SIN decimales (formato chileno) -->
        <td><strong>${{ p.precio|floatformat:"0" }}</strong></td>
        
        <!-- Cantidad en stock -->
        <td>{{ p.cantidad }}</td>
        
        <!-- Fecha de caducidad -->
        <td>{{ p.caducidad|date:"d/m/Y" }}</td>
        
        <!-- Acciones disponibles (solo Detalles y Editar) -->
        <td>
          <a href="{% url 'proximamente_feature' 'inventario-detalle' %}" 
             class="btn btn-sm btn-outline-primary" 
             title="Ver detalles del producto">
            <i class="bi bi-eye"></i> Detalles
          </a>
          <a href="{% url 'editar_producto' p.id %}" 
             class="btn btn-sm btn-outline-secondary"
             title="Editar producto">
            <i class="bi bi-pencil"></i> Editar
          </a>
        </td>
      </tr>
      {% empty %}
      <!-- Mensaje cuando no hay productos -->
      <tr>
        <td colspan="8" class="text-center py-4">
          <i class="bi bi-inbox" style="font-size: 2rem; color: #6c757d;"></i>
          <p class="mt-2 mb-0">No hay productos en el inventario.</p>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="form-link">
    <a href="{% url 'dashboard' %}">Volver al Dashboard</a>
  </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- ============================================ -->
<!-- JAVASCRIPT PARA ACCIONES MASIVAS            -->
<!-- ============================================ -->
{% block extra_js %}
<script>
/*
================================================================
=                                                              =
=         JAVASCRIPT PARA GESTIÓN DE ACCIONES MASIVAS         =
=                                                              =
================================================================

Este script maneja la funcionalidad de selección múltiple y
acciones masivas en el inventario.

FUNCIONALIDADES:
1. Seleccionar/deseleccionar todos los productos
2. Actualizar contador de productos seleccionados
3. Habilitar/deshabilitar botones según selección
4. Ejecutar acciones masivas (crear alertas, mover a merma, eliminar)
*/

// ============================================================
// VARIABLES GLOBALES
// ============================================================
const checkboxTodos = document.getElementById('checkbox-todos');
const checkboxesProductos = document.querySelectorAll('.producto-checkbox');
const contadorSeleccionados = document.getElementById('contador-seleccionados');
const btnCrearAlertas = document.getElementById('btn-crear-alertas');
const btnMoverMerma = document.getElementById('btn-mover-merma');
const btnEliminar = document.getElementById('btn-eliminar');

// ============================================================
// FUNCIÓN: Actualizar Estado de la Interfaz
// ============================================================
/**
 * Actualiza el contador y habilita/deshabilita los botones
 * según cuántos productos estén seleccionados.
 */
function actualizarEstado() {
    // Contar cuántos checkboxes están marcados
    const seleccionados = document.querySelectorAll('.producto-checkbox:checked');
    const cantidad = seleccionados.length;
    
    // Actualizar el texto del contador
    contadorSeleccionados.textContent = `${cantidad} seleccionado${cantidad !== 1 ? 's' : ''}`;
    
    // Cambiar el color del badge según la cantidad
    if (cantidad === 0) {
        contadorSeleccionados.className = 'badge bg-secondary';
    } else {
        contadorSeleccionados.className = 'badge bg-primary';
    }
    
    // Habilitar o deshabilitar los botones
    const haySeleccion = cantidad > 0;
    btnCrearAlertas.disabled = !haySeleccion;
    btnMoverMerma.disabled = !haySeleccion;
    btnEliminar.disabled = !haySeleccion;
}

// ============================================================
// EVENTO: Checkbox "Seleccionar Todos"
// ============================================================
/**
 * Cuando se hace clic en el checkbox del header,
 * selecciona o deselecciona todos los productos.
 */
if (checkboxTodos) {
    checkboxTodos.addEventListener('change', function() {
        const estaSeleccionado = this.checked;
        
        // Marcar o desmarcar todos los checkboxes de productos
        checkboxesProductos.forEach(checkbox => {
            checkbox.checked = estaSeleccionado;
        });
        
        // Actualizar el estado de la interfaz
        actualizarEstado();
    });
}

// ============================================================
// EVENTO: Checkboxes Individuales
// ============================================================
/**
 * Cuando se hace clic en un checkbox individual,
 * actualiza el estado del checkbox "todos" y la interfaz.
 */
checkboxesProductos.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        // Verificar si todos están seleccionados
        const todosSeleccionados = Array.from(checkboxesProductos)
            .every(cb => cb.checked);
        
        // Actualizar el checkbox "todos"
        if (checkboxTodos) {
            checkboxTodos.checked = todosSeleccionados;
        }
        
        // Actualizar el estado de la interfaz
        actualizarEstado();
    });
});

// ============================================================
// FUNCIÓN: Ejecutar Acción Masiva
// ============================================================
/**
 * Ejecuta una acción sobre todos los productos seleccionados.
 * 
 * @param {string} accion - Tipo de acción: 'crear_alertas', 'mover_merma', 'eliminar'
 */
function accionMasiva(accion) {
    // Obtener los IDs de los productos seleccionados
    const seleccionados = document.querySelectorAll('.producto-checkbox:checked');
    const ids = Array.from(seleccionados).map(cb => cb.value);
    
    // Validar que haya productos seleccionados
    if (ids.length === 0) {
        alert('Por favor, selecciona al menos un producto.');
        return;
    }
    
    // Obtener los nombres de los productos para mostrar en la confirmación
    const nombres = Array.from(seleccionados)
        .map(cb => cb.dataset.nombre)
        .slice(0, 3); // Mostrar máximo 3 nombres
    
    const masProductos = ids.length > 3 ? ` y ${ids.length - 3} más` : '';
    const listaProductos = nombres.join(', ') + masProductos;
    
    // Mensajes de confirmación según la acción
    let mensaje = '';
    let urlDestino = '';
    
    switch(accion) {
        case 'crear_alertas':
            mensaje = `¿Crear alertas para ${ids.length} producto(s)?\n\n${listaProductos}`;
            urlDestino = '/api/acciones-masivas/crear-alertas/';
            break;
        case 'mover_merma':
            mensaje = `¿Mover ${ids.length} producto(s) a MERMA?\n\n${listaProductos}\n\nEsta acción cambiará el estado de los productos.`;
            urlDestino = '/api/acciones-masivas/mover-merma/';
            break;
        case 'eliminar':
            mensaje = `¿ELIMINAR ${ids.length} producto(s)?\n\n${listaProductos}\n\n⚠️ Esta acción no se puede deshacer.`;
            urlDestino = '/api/acciones-masivas/eliminar/';
            break;
    }
    
    // Pedir confirmación al usuario
    if (!confirm(mensaje)) {
        return;
    }
    
    // Mostrar indicador de carga
    const btnActual = event.target.closest('button');
    const textoOriginal = btnActual.innerHTML;
    btnActual.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
    btnActual.disabled = true;
    
    // Enviar la petición al servidor
    fetch(urlDestino, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ ids: ids })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de éxito
            alert(data.message || 'Acción completada exitosamente');
            // Recargar la página para ver los cambios
            window.location.reload();
        } else {
            // Mostrar mensaje de error
            alert(data.message || 'Ocurrió un error al procesar la acción');
            // Restaurar el botón
            btnActual.innerHTML = textoOriginal;
            btnActual.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión. Por favor, intenta de nuevo.');
        // Restaurar el botón
        btnActual.innerHTML = textoOriginal;
        btnActual.disabled = false;
    });
}

// ============================================================
// FUNCIÓN AUXILIAR: Obtener Cookie CSRF
// ============================================================
/**
 * Obtiene el token CSRF de las cookies para enviarlo en las peticiones POST.
 * Django requiere este token para validar las peticiones.
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ============================================================
// INICIALIZACIÓN
// ============================================================
// Actualizar el estado inicial al cargar la página
actualizarEstado();
</script>
{% endblock %}